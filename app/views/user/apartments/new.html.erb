<h1 class="page-title">登錄公寓</h1>

<%= simple_form_for(@image, url: user_images_path, html: {class: "dropzone", id: "newImageForm"}) do |f| %>
<% end %>

<%= simple_form_for(@apartment, url: user_apartments_path, wrapper: :horizontal_form, html: {class: "form-horizontal"}) do |f| %>
  <%#= f.hidden_field :image_ids, value: [] %>
  <%= f.input :discription, label: "公寓介紹" %>
  <%= f.simple_fields_for(:address, @address, wrapper: false) do |address| %>
    <div class="form-group">
      <label for="tenant_rent_case_apartment_attributes_address_attributes_city_id" class="col-sm-2 control-label">請選擇縣市</label>
      <div class="col-sm-4">
        <%= address.input :city_id, collection: @cities, label: false, prompt: "縣市", input_html: {class: "apartment_address_attributes_city"}, wrapper: false %>
      </div>
      <label for="tenant_rent_case_apartment_attributes_address_attributes_district_id" class="col-sm-2 control-label">請選擇行政區</label>
      <div class="col-sm-4">
        <%= address.input :district_id, collection: [], label: false, prompt: "行政區", input_html: {class: "apartment_address_attributes_district col-sm-6"}, wrapper: false %>
      </div>
    </div>
    <div class="form-group">
      <label for="tenant_rent_case_apartment_attributes_address_attributes_street" class="col-sm-2 control-label">街道</label>
      <div class="col-sm-10">
        <%= address.input :street, label: false, class: "form-control", wrapper: false %>
      </div>
    </div>
  <% end %>
  <hr>
  <%= f.button :submit, "張貼", class: "btn btn-primary pull-right btn-lg" %>
<% end %>
  


<%= render "user/apartments/address_initializer" %>
<script>
  var ready = function() {
    Dropzone.autoDiscover = false;
    $("#newImageForm").dropzone({
      url: "<%= user_images_path %>",
      autoProcessQueue: true,
      uploadMultiple: true,
      parallelUploads: 100,
      maxFiles: 100,
      addRemoveLinks: true,
      dictDefaultMessage: "點按選取圖片，或將圖片拖入",

      // The setting up of the dropzone
      init: function() {
        var myDropzone = this;
        // this.on("sendingmultiple", function() {
        // });
        this.on("successmultiple", function(files, response) {
          var responseLength = response.length;
          for(var i = 0; i < responseLength; i++ ){
            files[i].serverID = response[i];
            $('<input>').attr({
                type: 'hidden',
                id: response[i],
                name: 'apartment[image_ids][]',
                value: response[i]
            }).appendTo('#new_apartment');
          };
        });
        // this.on("errormultiple", function(files, response) {
        //   // Gets triggered when there was an error sending the files.
        //   // Maybe show form again, and notify user of error
        // });
        this.on("removedfile", function(file, response) {
          $.ajax({
            url: "/dashboard/images/" + file.serverID,
            type: "DELETE",
            success: function(data){
              var image = document.getElementById(file.serverID);
              image.remove();
            }
          })
        });
      }
    });
  };
  $(document).ready(ready);
  $(document).on('page:load', ready);
// })
</script>

